# 阿瓦隆小程序部署指南

## 📋 部署检查清单

### 开发阶段
- [ ] 所有页面测试通过
- [ ] 所有云函数已上传并部署
- [ ] 数据库集合已创建
- [ ] 角色分配功能正常
- [ ] 游戏流程完整
- [ ] 真机预览测试通过

### 云函数清单
- [ ] createRoom（创建房间）
- [ ] getRoomInfo（获取房间信息）
- [ ] joinRoom（加入房间）
- [ ] dealCards（分配角色）
- [ ] getPlayerRole（获取玩家角色）
- [ ] submitNomination（提交提名）
- [ ] submitVote（提交投票）
- [ ] submitMission（提交任务结果）
- [ ] assassinate（刺杀）
- [ ] resetRoom（重置房间）

### 数据库集合
- [ ] rooms（房间集合）
- [ ] players（玩家集合）

## 🚀 快速部署步骤

### 1. 修改配置

修改 `miniprogram/app.js`：

```javascript
wx.cloud.init({
  env: 'cloud1-7gdxiqxud6591054', // 替换为你的云环境ID
  traceUser: true,
})
```

### 2. 批量上传云函数

在微信开发者工具中：

1. 右键点击 `cloudfunctions` 文件夹
2. 选择 **同时上传所有云函数**
3. 或者逐个上传每个云函数文件夹

**重要**：选择 **上传并部署：云端安装依赖（不上传node_modules）**

### 3. 创建数据库集合

在云开发控制台 -> 数据库：

1. 创建 `rooms` 集合
   - 权限设置：仅创建者可读写，所有人可读

2. 创建 `players` 集合
   - 权限设置：仅创建者可读写，所有人可读

### 4. 测试功能

依次测试以下功能：

1. ✅ 创建房间（3-12人）
2. ✅ 加入房间
3. ✅ 分配角色
4. ✅ 查看身份（不同角色看到不同信息）
5. ✅ 队长提名
6. ✅ 投票
7. ✅ 任务执行
8. ✅ 刺杀阶段
9. ✅ 游戏结束

### 5. 真机预览

1. 点击微信开发者工具的 **预览** 按钮
2. 使用微信扫码
3. 在手机上完整测试游戏流程
4. 邀请朋友一起测试多人游戏

## 📱 分享给朋友使用

### 方式一：体验版（推荐）

**优点**：无需审核，立即可用

**步骤**：

1. 在微信开发者工具中点击 **上传**
2. 填写版本号（如：`1.0.0`）
3. 填写项目备注（如：`阿瓦隆桌游助手`）
4. 访问 [微信公众平台](https://mp.weixin.qq.com/)
5. 进入 **版本管理** -> 选择刚上传的版本
6. 点击 **选为体验版**
7. 保存体验版二维码分享给朋友
8. 或在 **成员管理** -> **体验成员** 中添加朋友的微信号

**限制**：最多50个体验者

### 方式二：正式版

**优点**：无人数限制，更稳定

**步骤**：

1. 完善小程序信息（名称、简介、头像、服务类目）
2. 上传代码版本
3. 提交审核
4. 等待审核通过（1-7个工作日）
5. 审核通过后发布

## 🔧 配置说明

### 1. 角色配置

位置：`miniprogram/utils/avalon-config.js`

可以修改以下内容：
- 各人数的角色配置
- 任务人数配置
- 任务失败票要求

### 2. 游戏规则

位置：`miniprogram/utils/game-rules.js`

可以修改规则说明的内容

### 3. 样式主题

各页面的 `.wxss` 文件可以修改颜色主题：

当前主题色：
- 主色调：`#667eea` 到 `#764ba2` 渐变
- 好人色：`#4caf50` 绿色
- 坏人色：`#f44336` 红色

## 🎨 自定义功能

### 1. 修改房间号生成规则

位置：`miniprogram/cloudfunctions/createRoom/index.js`

```javascript
// 当前：生成4位数字
const generateRoomId = () => {
  const min = 1000
  const max = 9999
  return Math.floor(Math.random() * (max - min + 1)) + min
}

// 可改为：生成6位字母数字组合
// 或其他格式
```

### 2. 添加房间密码

需要修改：
- `createRoom` 云函数：添加密码字段
- `joinRoom` 云函数：验证密码
- 创建房间页面：添加密码输入
- 加入房间页面：添加密码验证

### 3. 添加游戏历史

需要：
- 创建 `game_history` 数据库集合
- 游戏结束时保存游戏记录
- 添加历史记录页面

## 📊 数据库结构

### rooms 集合

```javascript
{
  _id: "1234",                    // 房间号
  max_players: 5,                 // 最大人数
  status: "nominating",           // 状态
  game_state: {                   // 游戏状态
    current_mission: 0,           // 当前任务（0-4）
    current_round: 0,             // 当前轮次
    current_leader: 0,            // 当前队长
    mission_results: [],          // 任务结果
    vote_history: [],             // 投票历史
    consecutive_rejects: 0,       // 连续否决次数
    good_wins: 0,                 // 好人胜利次数
    evil_wins: 0,                 // 坏人胜利次数
    nominated_players: [],        // 被提名玩家
    votes: {},                    // 投票记录
    mission_submissions: {}       // 任务提交
  },
  mission_config: [],             // 任务配置
  created_at: Date,
  updated_at: Date
}
```

### players 集合

```javascript
{
  _id: "xxx",
  room_id: "1234",               // 房间号
  player_number: 1,              // 玩家编号
  nickname: "玩家1",             // 昵称
  role: {                        // 角色
    name: "梅林",
    side: "good",
    code: "merlin"
  },
  openid: "xxx",                 // 微信openid
  created_at: Date
}
```

## 🔒 安全建议

### 1. 数据库权限

设置为：
- 仅创建者可读写
- 所有人可读

### 2. 云函数安全

- 验证房间是否存在
- 验证玩家权限
- 验证游戏状态
- 防止重复提交

### 3. 敏感信息保护

- 不要在客户端存储敏感信息
- 使用云函数处理关键逻辑
- 避免直接暴露角色信息

## 💰 费用说明

微信云开发免费版：

- 云函数调用量：每月 100 万次
- 云数据库存储：2GB
- 云数据库读操作：每月 5 万次
- 云数据库写操作：每月 3 万次

**估算**：假设每局游戏30分钟，约产生：
- 云函数调用：约100次
- 数据库读写：约50次

免费额度可支持：
- 每月约1万局游戏
- 完全够朋友间使用

## 🐛 故障排查

### 问题1：云函数调用失败

**检查项**：
- [ ] 云函数是否已上传
- [ ] 云环境ID是否正确
- [ ] 云函数名称是否匹配
- [ ] 网络是否正常

**解决方案**：
1. 重新上传云函数
2. 检查 `app.js` 中的环境ID
3. 查看云开发控制台的日志

### 问题2：角色分配失败

**检查项**：
- [ ] 人数是否在3-12之间
- [ ] 数据库集合是否创建
- [ ] 云函数 `dealCards` 是否正常

**解决方案**：
1. 检查人数范围
2. 查看云函数日志
3. 重新上传云函数

### 问题3：游戏状态不同步

**检查项**：
- [ ] 网络是否稳定
- [ ] 定时器是否正常
- [ ] 数据库权限是否正确

**解决方案**：
1. 刷新页面
2. 重新进入房间
3. 检查数据库权限设置

### 问题4：投票/任务提交失败

**检查项**：
- [ ] 游戏状态是否正确
- [ ] 是否重复提交
- [ ] 云函数逻辑是否正确

**解决方案**：
1. 查看云函数日志
2. 检查游戏状态
3. 重新提交

## 📞 技术支持

如遇到问题：

1. 查看微信开发者工具的控制台错误
2. 查看云开发控制台的云函数日志
3. 检查数据库集合和权限设置
4. 参考微信官方文档

## 🎉 部署完成

完成以上步骤后，你就可以：

1. ✅ 邀请朋友一起玩阿瓦隆
2. ✅ 体验完整的游戏流程
3. ✅ 随时查看游戏规则
4. ✅ 支持3-12人游戏

祝部署顺利，游戏愉快！🎮
