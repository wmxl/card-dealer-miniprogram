<!--pages/game/game.wxml-->
<view class="container">
  <view class="top-row">
    <view class="action-btn" bindtap="showRole">
      <text>ğŸ­ èº«ä»½</text>
    </view>
    <view class="action-btn" bindtap="showRules">
      <text>ğŸ“– è§„åˆ™</text>
    </view>
    <view class="action-btn danger" bindtap="resetGame">
      <text>ğŸ”„ é‡å¼€</text>
    </view>
  </view>

  <view wx:if="{{loading}}" class="loading">
    <text>åŠ è½½ä¸­...</text>
  </view>

  <view wx:else class="content">
    <!-- æ¸¸æˆè¿›åº¦ -->
    <view class="game-progress">
      <view class="mission-track">
        <view
          class="mission-item {{missionResults[index] ? (missionResults[index].success ? 'mission-success' : 'mission-failed') : (index <= currentMission ? 'active' : '')}}"
          wx:for="{{missionConfig}}"
          wx:key="index"
          data-mission="{{index}}"
          bindtap="showMissionVotes"
          hover-class="mission-item-hover"
        >
          <view class="mission-number">ä»»åŠ¡{{index + 1}}</view>
          <view class="mission-players">{{item.players}}äºº</view>
          <view wx:if="{{missionResults[index]}}" class="mission-result-badge">
            {{missionResults[index].success ? 'âœ“' : 'âœ—'}}
          </view>
        </view>
      </view>

      <view class="score-display">
        <view class="score-item good">
          <text class="score-label">æˆåŠŸæ¬¡æ•°</text>
          <text class="score-value">{{goodWins}}</text>
        </view>
        <view class="score-item evil">
          <text class="score-label">å¤±è´¥æ¬¡æ•°</text>
          <text class="score-value">{{evilWins}}</text>
        </view>
      </view>
    </view>

    <!-- å½“å‰çŠ¶æ€ -->
    <view wx:if="{{!reviewMode}}" class="status-section">
      <view class="current-leader">
        <text class="leader-label">å½“å‰é˜Ÿé•¿ï¼š</text>
        <text class="leader-number">{{currentLeader + 1}}å·</text>
        <text wx:if="{{isLeader}}" class="leader-badge">ï¼ˆä½ ï¼‰</text>
      </view>

      <view wx:if="{{consecutiveRejects > 0}}" class="warning-banner">
        âš ï¸ å·²è¿ç»­å¦å†³{{consecutiveRejects}}æ¬¡ï¼Œå†å¦å†³{{rejectsUntilLoss}}æ¬¡åäººç›´æ¥è·èƒœ
      </view>
    </view>
    <!-- å¤ç›˜é¢æ¿ -->
    <view wx:if="{{reviewMode}}" class="result-panel">
      <view class="result-title">{{gameResultTitle}}</view>
      <view wx:if="{{gameResultReason}}" class="result-reason">{{gameResultReason}}</view>
      <view class="role-list">
        <view class="role-item" wx:for="{{allPlayers}}" wx:key="player_number">
          <text class="role-number">{{item.player_number}}å·</text>
          <text class="role-name">{{item.nickname}}</text>
          <text wx:if="{{item.role}}" class="role-badge {{item.role.side || ''}}">
            {{item.role.name}}
          </text>
          <text wx:if="{{!item.role}}" class="role-badge">æœªçŸ¥èº«ä»½</text>
        </view>
      </view>
    </view>

    <!-- æåé˜¶æ®µ -->
    <view wx:if="{{!votePhase && !missionPhase && !reviewMode}}" class="nomination-section">
      <view class="section-title">
        ä»»åŠ¡{{currentMission + 1}}ï¼šé€‰æ‹©{{missionConfig[currentMission].players}}äººæ‰§è¡Œä»»åŠ¡
      </view>

      <view wx:if="{{isLeader}}" class="leader-actions">
        <view class="players-grid">
          <view
            class="player-card {{selectedPlayersMap[item.player_number] ? 'selected' : ''}}"
            wx:for="{{allPlayers}}"
            wx:for-item="item"
            wx:key="player_number"
            data-player="{{item.player_number}}"
            bindtap="togglePlayerSelection"
          >
            <text class="player-card-number">{{item.player_number}}</text>
            <text class="player-card-name">{{item.nickname || 'ç©å®¶' + item.player_number}}</text>
          </view>
        </view>

        <view class="selected-count">
          å·²é€‰æ‹©ï¼š{{selectedPlayers.length}}/{{missionConfig[currentMission].players}}
        </view>

        <button
          class="btn btn-primary"
          bindtap="submitNomination"
          disabled="{{selectedPlayers.length !== missionConfig[currentMission].players}}"
        >
          æäº¤æå
        </button>
      </view>

      <view wx:else class="waiting-message">
        <text>ç­‰å¾…é˜Ÿé•¿æåç©å®¶...</text>
      </view>
    </view>

    <!-- æŠ•ç¥¨é˜¶æ®µ -->
    <view wx:if="{{votePhase && !reviewMode}}" class="vote-section">
      <view class="section-title">æŠ•ç¥¨é˜¶æ®µ</view>

      <view class="nominated-players">
        <text class="nominated-label">æåç©å®¶ï¼š</text>
        <view class="nominated-list">
          <view
            class="nominated-player"
            wx:for="{{nominatedPlayersInfo}}"
            wx:key="number"
          >
            <text class="nom-number">{{item.number}}å·</text>
            <text class="nom-name">{{item.nickname}}</text>
          </view>
        </view>
      </view>

      <view class="vote-buttons">
        <button
          class="btn btn-approve {{myVoteChoice === true ? 'vote-selected' : ''}}"
          data-approve="true"
          bindtap="vote"
          disabled="{{myVoteChoice !== null}}"
        >
          èµæˆ ğŸ‘
        </button>
        <button
          class="btn btn-reject {{myVoteChoice === false ? 'vote-selected' : ''}}"
          data-approve="false"
          bindtap="vote"
          disabled="{{myVoteChoice !== null}}"
        >
          åå¯¹ ğŸ‘
        </button>
      </view>

      <view class="vote-tip">
        æŠ•ç¥¨å°†å…¬å¼€æ˜¾ç¤ºï¼Œè¶…è¿‡åŠæ•°èµæˆåˆ™æ‰§è¡Œä»»åŠ¡
      </view>
    </view>

    <!-- ä»»åŠ¡æ‰§è¡Œé˜¶æ®µ -->
    <view wx:if="{{missionPhase && !reviewMode}}" class="mission-section">
      <view class="section-title">ä»»åŠ¡æ‰§è¡Œ</view>

      <view class="mission-message">
        ç­‰å¾…é€‰ä¸­ç©å®¶æ‰§è¡Œä»»åŠ¡...
      </view>
    </view>
  </view>

  <!-- è§„åˆ™å¼¹çª— -->
  <rules-modal show="{{showRulesModal}}" bind:close="hideRules"></rules-modal>

  <!-- èº«ä»½å¼¹çª— -->
  <view wx:if="{{showRoleModal}}" class="modal-overlay" bindtap="hideRole">
    <view class="role-modal" catchtap="stopPropagation">
      <view class="role-modal-header {{role.side}}">
        <text class="role-modal-title">{{role.name}}</text>
        <text class="role-modal-side">{{role.side === 'good' ? 'å¥½äººé˜µè¥' : 'åäººé˜µè¥'}}</text>
      </view>
      <view class="role-modal-content">
        <view class="role-modal-message">{{role.message}}</view>
        <view wx:if="{{role.seePlayers && role.seePlayers.length > 0}}" class="role-modal-players">
          <view class="role-modal-subtitle">ä½ çŸ¥é“çš„ä¿¡æ¯ï¼š</view>
          <view wx:for="{{role.seePlayers}}" wx:key="number" class="role-modal-player">
            <text class="player-num">{{item.number}}å·</text>
            <text class="player-nickname">{{item.nickname}}</text>
            <text class="player-role">- {{item.roleName}}</text>
          </view>
        </view>
        <view wx:if="{{role.tip}}" class="role-modal-tip">
          ğŸ’¡ {{role.tip}}
        </view>
      </view>
      <view class="role-modal-footer">
        <button class="btn-close" bindtap="hideRole">å…³é—­</button>
      </view>
    </view>
  </view>

  <!-- ä»»åŠ¡æŠ•ç¥¨è®°å½•å¼¹çª— -->
  <view wx:if="{{voteHistoryModalVisible}}" class="modal-overlay" bindtap="closeVoteHistoryModal">
    <view class="vote-modal" catchtap="stopPropagation">
      <view class="vote-modal-header">
        <text class="vote-modal-title">ä»»åŠ¡{{voteHistoryMission + 1}}æŠ•ç¥¨è®°å½•</text>
      </view>
      <view class="vote-modal-content">
        <block wx:if="{{!voteHistoryEmpty}}">
          <block wx:for="{{voteHistoryRounds}}" wx:key="round">
            <view class="vote-round">
              <view class="vote-round-header">ç¬¬{{item.round + 1}}è½®</view>
              <view class="vote-round-list">
                <view class="vote-round-player" wx:for="{{item.votes}}" wx:for-item="vote" wx:key="player_number">
                  <text class="vote-player-number">{{vote.player_number}}å·</text>
                  <text class="vote-player-name">{{vote.nickname}}</text>
                  <text class="vote-player-result {{vote.approve ? 'approve' : 'reject'}}">
                    {{vote.approve ? 'èµæˆ' : 'åå¯¹'}}
                  </text>
                </view>
              </view>
            </view>
          </block>
        </block>
        <view wx:else class="vote-round-empty">
          æš‚æ— æŠ•ç¥¨è®°å½•
        </view>
      </view>
      <view class="vote-modal-footer">
        <button class="btn-close" bindtap="closeVoteHistoryModal">å…³é—­</button>
      </view>
    </view>
  </view>
</view>
