<!--pages/game/game.wxml-->
<view class="container">
  <view class="top-row">
    <view class="action-btn" bindtap="showRole">
      <text>ğŸ­ èº«ä»½</text>
    </view>
    <view class="action-btn" bindtap="showRules">
      <text>ğŸ“– è§„åˆ™</text>
    </view>
    <view class="action-btn danger" bindtap="resetGame">
      <text>ğŸ”„ é‡å¼€</text>
    </view>
  </view>

  <view wx:if="{{loading}}" class="loading">
    <text>åŠ è½½ä¸­...</text>
  </view>

  <view wx:else class="content">
    <!-- æ¸¸æˆè¿›åº¦ -->
    <view class="game-progress">
      <view class="mission-track">
        <view
          class="mission-item {{missionResults[index] ? (missionResults[index].success ? 'mission-success' : 'mission-failed') : (index <= currentMission ? 'active' : '')}}"
          wx:for="{{missionConfig}}"
          wx:key="index"
          data-mission="{{index}}"
          bindtap="showMissionVotes"
          hover-class="mission-item-hover"
        >
          <view class="mission-number">ä»»åŠ¡{{index + 1}}</view>
          <view class="mission-players">{{item.players}}äºº</view>
          <view wx:if="{{item.failsRequired >= 2}}" class="mission-protection">ä¿æŠ¤è½®</view>
          <view wx:if="{{missionResults[index]}}" class="mission-result-badge">
            {{missionResults[index].success ? 'âœ“' : 'âœ—'}}
          </view>
        </view>
      </view>

      <view class="score-display">
        <view class="score-item good">
          <text class="score-label">æˆåŠŸæ¬¡æ•°</text>
          <text class="score-value">{{goodWins}}</text>
        </view>
        <view class="score-item evil">
          <text class="score-label">å¤±è´¥æ¬¡æ•°</text>
          <text class="score-value">{{evilWins}}</text>
        </view>
      </view>
    </view>

    <!-- ç”¨æˆ·æ¨¡å— -->
    <view wx:if="{{!reviewMode}}" class="users-section">
      <view class="section-title">
        <text wx:if="{{!votePhase && !missionPhase}}">ä»»åŠ¡{{currentMission + 1}}ï¼šé€‰æ‹©{{missionConfig[currentMission].players}}äººæ‰§è¡Œä»»åŠ¡</text>
        <text wx:elif="{{votePhase}}">æŠ•ç¥¨é˜¶æ®µ</text>
        <text wx:elif="{{missionPhase}}">ä»»åŠ¡æ‰§è¡Œ</text>
      </view>

      <!-- ç”¨æˆ·åˆ—è¡¨ -->
      <view class="users-grid">
        <view
          class="user-card-wrapper {{item.player_number === currentLeader + 1 ? 'has-leader' : ''}}"
          wx:for="{{allPlayers}}"
          wx:for-item="item"
          wx:key="player_number"
        >
          <view wx:if="{{item.player_number === currentLeader + 1}}" class="leader-indicator">ğŸ‘‘ é˜Ÿé•¿</view>
          <view
            class="user-card {{selectedPlayersMap[item.player_number] ? 'selected' : ''}} {{item.player_number === currentLeader + 1 ? 'is-leader' : ''}} {{nominatedPlayersMap[item.player_number] ? 'nominated' : ''}} {{isLeader && !votePhase && !missionPhase ? 'selectable' : ''}}"
            data-player="{{item.player_number}}"
            bindtap="handleUserCardTap"
          >
            <view class="user-card-header">
              <text class="user-number">{{item.player_number}}å·</text>
            </view>
            <text class="user-name">{{item.nickname || 'ç©å®¶' + item.player_number}}</text>
            <view wx:if="{{selectedPlayersMap[item.player_number]}}" class="selected-badge">âœ“</view>
          </view>
        </view>
      </view>

      <!-- æåé˜¶æ®µæ“ä½œ -->
      <view wx:if="{{!votePhase && !missionPhase && isLeader}}" class="nomination-actions">
        <view class="selected-count">
          å·²é€‰æ‹©ï¼š{{selectedPlayers.length}}/{{missionConfig[currentMission].players}}
        </view>
        <button
          class="btn btn-primary"
          bindtap="submitNomination"
          disabled="{{selectedPlayers.length !== missionConfig[currentMission].players}}"
        >
          æäº¤æå
        </button>
      </view>

      <!-- ç­‰å¾…é˜Ÿé•¿æå -->
      <view wx:if="{{!votePhase && !missionPhase && !isLeader}}" class="waiting-message">
        <text>ç­‰å¾…é˜Ÿé•¿æåç©å®¶...</text>
      </view>

      <!-- æŠ•ç¥¨é˜¶æ®µæ“ä½œ -->
      <view wx:if="{{votePhase}}" class="vote-actions">
        <view class="vote-buttons">
          <button
            class="btn btn-approve {{myVoteChoice === true ? 'vote-selected' : ''}}"
            data-approve="true"
            bindtap="vote"
            disabled="{{myVoteChoice !== null}}"
          >
            èµæˆ ğŸ‘
          </button>
          <button
            class="btn btn-reject {{myVoteChoice === false ? 'vote-selected' : ''}}"
            data-approve="false"
            bindtap="vote"
            disabled="{{myVoteChoice !== null}}"
          >
            åå¯¹ ğŸ‘
          </button>
        </view>
        <view class="vote-tip">
          æŠ•ç¥¨å°†å…¬å¼€æ˜¾ç¤ºï¼Œè¶…è¿‡åŠæ•°èµæˆåˆ™æ‰§è¡Œä»»åŠ¡
        </view>
      </view>

      <!-- ä»»åŠ¡æ‰§è¡Œé˜¶æ®µæç¤º -->
      <view wx:if="{{missionPhase}}" class="mission-message">
        ç­‰å¾…é€‰ä¸­ç©å®¶æ‰§è¡Œä»»åŠ¡...
      </view>

      <!-- è­¦å‘Šæ¨ªå¹… -->
      <view wx:if="{{consecutiveRejects > 0}}" class="warning-banner">
        âš ï¸ å·²è¿ç»­å¦å†³{{consecutiveRejects}}æ¬¡ï¼Œå†å¦å†³{{rejectsUntilLoss}}æ¬¡åäººç›´æ¥è·èƒœ
      </view>
    </view>

    <!-- å¤ç›˜é¢æ¿ -->
    <view wx:if="{{reviewMode}}" class="result-panel">
      <view class="result-title">{{gameResultTitle}}</view>
      <view wx:if="{{gameResultReason}}" class="result-reason">{{gameResultReason}}</view>
      <view class="role-list">
        <view class="role-item" wx:for="{{allPlayers}}" wx:key="player_number">
          <text class="role-number">{{item.player_number}}å·</text>
          <text class="role-name">{{item.nickname}}</text>
          <text wx:if="{{item.role}}" class="role-badge {{item.role.side || ''}}">
            {{item.role.name}}
          </text>
          <text wx:if="{{!item.role}}" class="role-badge">æœªçŸ¥èº«ä»½</text>
        </view>
      </view>
    </view>

  </view>

  <!-- è§„åˆ™å¼¹çª— -->
  <rules-modal show="{{showRulesModal}}" bind:close="hideRules"></rules-modal>

  <!-- èº«ä»½å¼¹çª— -->
  <view wx:if="{{showRoleModal}}" class="modal-overlay" bindtap="hideRole">
    <view class="role-modal" catchtap="stopPropagation">
      <view class="role-modal-header {{role.side}}">
        <text class="role-modal-title">{{role.name}}</text>
        <text class="role-modal-side">{{role.side === 'good' ? 'å¥½äººé˜µè¥' : 'åäººé˜µè¥'}}</text>
      </view>
      <view class="role-modal-content">
        <view class="role-modal-message">{{role.message}}</view>
        <view wx:if="{{role.seePlayers && role.seePlayers.length > 0}}" class="role-modal-players">
          <view class="role-modal-subtitle">ä½ çŸ¥é“çš„ä¿¡æ¯ï¼š</view>
          <view wx:for="{{role.seePlayers}}" wx:key="number" class="role-modal-player">
            <text class="player-num">{{item.number}}å·</text>
            <text class="player-nickname">{{item.nickname}}</text>
            <text class="player-role">- {{item.roleName}}</text>
          </view>
        </view>
        <view wx:if="{{role.tip}}" class="role-modal-tip">
          ğŸ’¡ {{role.tip}}
        </view>
      </view>
      <view class="role-modal-footer">
        <button class="btn-close" bindtap="hideRole">å…³é—­</button>
      </view>
    </view>
  </view>

  <!-- ä»»åŠ¡ç»“æœå¼¹çª— -->
  <view wx:if="{{showMissionResultModal}}" class="modal-overlay" bindtap="closeMissionResultModal">
    <view class="mission-result-modal" catchtap="stopPropagation">
      <view class="mission-result-modal-content {{missionResultData.success ? 'success' : 'failed'}}">
        <!-- å›¾æ ‡ -->
        <view class="result-icon-wrapper">
          <view class="result-icon {{missionResultData.success ? 'success' : 'failed'}}">
            {{missionResultData.success ? 'âœ“' : 'âœ—'}}
          </view>
        </view>

        <!-- æ ‡é¢˜ -->
        <view class="result-title">
          {{missionResultData.success ? 'ä»»åŠ¡æˆåŠŸ' : 'ä»»åŠ¡å¤±è´¥'}}
        </view>

        <!-- ä»»åŠ¡ç¼–å· -->
        <view class="result-mission-number">
          ä»»åŠ¡ {{missionResultData.mission}}
        </view>

        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <view class="result-cards">
          <view class="result-card success-card">
            <view class="card-icon">âœ“</view>
            <view class="card-label">æˆåŠŸ</view>
            <view class="card-value">{{missionResultData.success_count}}</view>
            <view class="card-unit">å¼ </view>
          </view>
          <view class="result-card fail-card">
            <view class="card-icon">âœ—</view>
            <view class="card-label">å¤±è´¥</view>
            <view class="card-value">{{missionResultData.fail_count}}</view>
            <view class="card-unit">å¼ </view>
          </view>
        </view>

        <!-- ç¡®å®šæŒ‰é’® -->
        <view class="result-btn-wrapper">
          <button class="result-btn" bindtap="closeMissionResultModal">ç¡®å®š</button>
        </view>
      </view>
    </view>
  </view>

  <!-- ä»»åŠ¡æŠ•ç¥¨è®°å½•å¼¹çª— -->
  <view wx:if="{{voteHistoryModalVisible}}" class="modal-overlay" bindtap="closeVoteHistoryModal">
    <view class="vote-modal" catchtap="stopPropagation">
      <view class="vote-modal-header">
        <text class="vote-modal-title">ä»»åŠ¡{{voteHistoryMission + 1}}æŠ•ç¥¨è®°å½•</text>
      </view>
      <view class="vote-modal-content">
        <!-- ä»»åŠ¡ç»“æœæ˜¾ç¤º -->
        <view wx:if="{{voteHistoryMissionResult}}" class="mission-result-display">
          <view class="mission-result-title {{voteHistoryMissionResult.success ? 'success' : 'failed'}}">
            {{voteHistoryMissionResult.success ? 'ä»»åŠ¡æˆåŠŸ' : 'ä»»åŠ¡å¤±è´¥'}}
          </view>
          <view class="mission-result-stats">
            <view class="result-stat success">
              <text class="stat-label">æˆåŠŸ</text>
              <text class="stat-value">{{voteHistoryMissionResult.success_count}}å¼ </text>
            </view>
            <view class="result-stat failed">
              <text class="stat-label">å¤±è´¥</text>
              <text class="stat-value">{{voteHistoryMissionResult.fail_count}}å¼ </text>
            </view>
          </view>
          <!-- å‚ä¸ç©å®¶ç¼–å· -->
          <view wx:if="{{voteHistoryMissionResult.participants && voteHistoryMissionResult.participants.length > 0}}" class="mission-participants">
            <text class="participants-label">å‚ä¸ç©å®¶ï¼š</text>
            <block wx:for="{{voteHistoryMissionResult.participants}}" wx:key="*this" wx:for-index="idx">
              <text class="participants-numbers">{{item}}å·{{idx < voteHistoryMissionResult.participants.length - 1 ? 'ã€' : ''}}</text>
            </block>
          </view>
        </view>

        <!-- æŠ•ç¥¨è®°å½•æ ‡é¢˜ -->
        <view wx:if="{{voteHistoryMissionResult}}" class="vote-history-divider">
          <text class="vote-history-title">æŠ•ç¥¨è®°å½•</text>
        </view>

        <block wx:if="{{!voteHistoryEmpty}}">
          <block wx:for="{{voteHistoryRounds}}" wx:key="round">
            <view class="vote-round">
              <view class="vote-round-header">ç¬¬{{item.round + 1}}è½®</view>
              <view class="vote-round-list">
                <view class="vote-round-player" wx:for="{{item.votes}}" wx:for-item="vote" wx:key="player_number">
                  <text class="vote-player-number">{{vote.player_number}}å·</text>
                  <text class="vote-player-name">{{vote.nickname}}</text>
                  <text class="vote-player-result {{vote.approve ? 'approve' : 'reject'}}">
                    {{vote.approve ? 'èµæˆ' : 'åå¯¹'}}
                  </text>
                </view>
              </view>
            </view>
          </block>
        </block>
        <view wx:else class="vote-round-empty">
          æš‚æ— æŠ•ç¥¨è®°å½•
        </view>
      </view>
      <view class="vote-modal-footer">
        <button class="btn-close" bindtap="closeVoteHistoryModal">å…³é—­</button>
      </view>
    </view>
  </view>
</view>
