<!--pages/game/game.wxml-->
<view class="container">
  <!-- è§„åˆ™æŒ‰é’® -->
  <view class="rules-btn" bindtap="showRules">
    <text>ğŸ“– è§„åˆ™</text>
  </view>

  <!-- æˆ¿é—´å· -->
  <view class="room-header">
    <text class="room-id-label">æˆ¿é—´å·ï¼š</text>
    <text class="room-id-value">{{roomId}}</text>
  </view>

  <view wx:if="{{loading}}" class="loading">
    <text>åŠ è½½ä¸­...</text>
  </view>

  <view wx:else class="content">
    <!-- æ¸¸æˆè¿›åº¦ -->
    <view class="game-progress">
      <view class="mission-track">
        <view
          class="mission-item {{index <= currentMission ? 'active' : ''}} {{item.result}}"
          wx:for="{{missionConfig}}"
          wx:key="*this"
        >
          <view class="mission-number">ä»»åŠ¡{{index + 1}}</view>
          <view class="mission-players">{{item.players}}äºº</view>
          <view wx:if="{{missionResults[index]}}" class="mission-result">
            {{missionResults[index].success ? 'âœ“' : 'âœ—'}}
          </view>
        </view>
      </view>

      <view class="score-display">
        <view class="score-item good">
          <text class="score-label">å¥½äºº</text>
          <text class="score-value">{{goodWins}}</text>
        </view>
        <view class="score-item evil">
          <text class="score-label">åäºº</text>
          <text class="score-value">{{evilWins}}</text>
        </view>
      </view>
    </view>

    <!-- å½“å‰çŠ¶æ€ -->
    <view class="status-section">
      <view class="current-leader">
        <text class="leader-label">å½“å‰é˜Ÿé•¿ï¼š</text>
        <text class="leader-number">{{currentLeader + 1}}å·</text>
        <text wx:if="{{isLeader}}" class="leader-badge">ï¼ˆä½ ï¼‰</text>
      </view>

      <view wx:if="{{consecutiveRejects > 0}}" class="warning-banner">
        âš ï¸ å·²è¿ç»­å¦å†³{{consecutiveRejects}}æ¬¡ï¼Œå†å¦å†³{{5 - consecutiveRejects}}æ¬¡åäººç›´æ¥è·èƒœ
      </view>
    </view>

    <!-- æåé˜¶æ®µ -->
    <view wx:if="{{!votePhase && !missionPhase}}" class="nomination-section">
      <view class="section-title">
        ä»»åŠ¡{{currentMission + 1}}ï¼šé€‰æ‹©{{missionConfig[currentMission].players}}äººæ‰§è¡Œä»»åŠ¡
      </view>

      <view wx:if="{{isLeader}}" class="leader-actions">
        <view class="players-grid">
          <view
            class="player-card {{selectedPlayers.indexOf(item.player_number) > -1 ? 'selected' : ''}}"
            wx:for="{{allPlayers}}"
            wx:key="player_number"
            data-player="{{item.player_number}}"
            bindtap="togglePlayerSelection"
          >
            <text class="player-card-number">{{item.player_number}}</text>
            <text class="player-card-name">{{item.nickname || 'ç©å®¶' + item.player_number}}</text>
          </view>
        </view>

        <view class="selected-count">
          å·²é€‰æ‹©ï¼š{{selectedPlayers.length}}/{{missionConfig[currentMission].players}}
        </view>

        <button
          class="btn btn-primary"
          bindtap="submitNomination"
          disabled="{{selectedPlayers.length !== missionConfig[currentMission].players}}"
        >
          æäº¤æå
        </button>
      </view>

      <view wx:else class="waiting-message">
        <text>ç­‰å¾…é˜Ÿé•¿æåç©å®¶...</text>
      </view>
    </view>

    <!-- æŠ•ç¥¨é˜¶æ®µ -->
    <view wx:if="{{votePhase}}" class="vote-section">
      <view class="section-title">æŠ•ç¥¨é˜¶æ®µ</view>

      <view class="nominated-players">
        <text class="nominated-label">æåç©å®¶ï¼š</text>
        <view class="nominated-list">
          <view
            class="nominated-player"
            wx:for="{{nominatedPlayersInfo}}"
            wx:key="number"
          >
            <text class="nom-number">{{item.number}}å·</text>
            <text class="nom-name">{{item.nickname}}</text>
          </view>
        </view>
      </view>

      <view class="vote-buttons">
        <button
          class="btn btn-approve"
          data-approve="true"
          bindtap="vote"
        >
          èµæˆ ğŸ‘
        </button>
        <button
          class="btn btn-reject"
          data-approve="false"
          bindtap="vote"
        >
          åå¯¹ ğŸ‘
        </button>
      </view>

      <view class="vote-tip">
        æŠ•ç¥¨å°†å…¬å¼€æ˜¾ç¤ºï¼Œè¶…è¿‡åŠæ•°èµæˆåˆ™æ‰§è¡Œä»»åŠ¡
      </view>
    </view>

    <!-- ä»»åŠ¡æ‰§è¡Œé˜¶æ®µ -->
    <view wx:if="{{missionPhase}}" class="mission-section">
      <view class="section-title">ä»»åŠ¡æ‰§è¡Œ</view>

      <view class="mission-message">
        ç­‰å¾…é€‰ä¸­ç©å®¶æ‰§è¡Œä»»åŠ¡...
      </view>
    </view>
  </view>

  <!-- è§„åˆ™å¼¹çª— -->
  <rules-modal show="{{showRulesModal}}" bind:close="hideRules"></rules-modal>
</view>
